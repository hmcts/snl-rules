#!groovy

@Library("Infrastructure")

product = "snl"
component = "rules"
environment = "preview"
planOnly = false
subscription = "nonprod"
vm_size = "Standard_E2s_v3"
rules_engine_subnet = "snl-rules-engine"

echo "Building '${product}-${component}' in '${environment}'"

node {
  def az = { cmd -> return sh(script: "env AZURE_CONFIG_DIR=/opt/jenkins/.azure-${env.SUBSCRIPTION_NAME} az $cmd", returnStdout: true).trim() }

  stage('Checkout') {
    deleteDir()
    checkout scm
  }

  withSubscription(subscription) {
    after('checkout') {
      echo 'sln-rules checked out'
    }

    before('buildinfra:prod') {
      error 'This is PoC project for Scheduling and Listing therefore the prod environment will not be built'
    }

    env.TF_VAR_product = "${product}"
    env.TF_VAR_component = "${component}"
    env.TF_VAR_env = "${environment}"
    env.TF_VAR_vm_size = "${vm_size}"
    env.TF_VAR_rules_engine_subnet = "${rules_engine_subnet}"
    env.TF_VAR_consul = az "vmss nic list --resource-group 'core-infra-${environment}' --vmss-name consul-server --query '[0].ipConfigurations[0].privateIpAddress'"

    stage("spinInfra") {
      spinInfra(product, component, environment, planOnly, subscription)
    }
  }
}
